#!/bin/bash
set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Parse arguments
DEV_MODE=false
WITH_DEMO=false

for arg in "$@"; do
    case $arg in
        --dev)
            DEV_MODE=true
            ;;
        --with-demo)
            WITH_DEMO=true
            ;;
    esac
done

# Configuration
GITHUB_REPO="towlabs/dashfrog"
GITHUB_BRANCH="main"
BASE_URL="https://raw.githubusercontent.com/${GITHUB_REPO}/${GITHUB_BRANCH}"
COMPOSE_FILE="docker-compose.yml"
if [ "$DEV_MODE" = true ]; then
    COMPOSE_FILE="docker-compose.dev.yml"
fi

echo -e "${BLUE}"
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘         DashFrog Installer            â•‘"
echo "â•‘  Customer-scoped observability for    â•‘"
echo "â•‘           B2B SaaS                    â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "${NC}"

# Check if Docker is installed
if ! command -v docker &> /dev/null; then
    echo -e "${RED}âŒ Docker is not installed. Please install Docker first.${NC}"
    echo "Visit: https://docs.docker.com/get-docker/"
    exit 1
fi

# Check if Docker Compose is installed
if ! docker compose version &> /dev/null; then
    echo -e "${RED}âŒ Docker Compose is not installed or not available.${NC}"
    exit 1
fi

# Check if Docker daemon is running
if ! docker info &> /dev/null; then
    echo -e "${RED}âŒ Docker daemon is not running. Please start Docker first.${NC}"
    exit 1
fi

echo -e "${BLUE}ðŸ“¦ Setting up DashFrog...${NC}"
echo ""

# Create installation directory
INSTALL_DIR="dashfrog"
if [ -d "$INSTALL_DIR" ]; then
    echo -e "${YELLOW}âš ï¸  Directory '$INSTALL_DIR' already exists.${NC}"
    read -p "Do you want to overwrite it? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${RED}Installation cancelled.${NC}"
        exit 1
    fi
    rm -rf "$INSTALL_DIR"
fi

mkdir -p "$INSTALL_DIR"
cd "$INSTALL_DIR"

echo -e "${BLUE}ðŸ“¥ Downloading configuration files...${NC}"

# Download docker-compose file
if ! curl -fsSL -o docker-compose.yml "${BASE_URL}/dashfrog/${COMPOSE_FILE}"; then
    echo -e "${RED}âŒ Failed to download ${COMPOSE_FILE}${NC}"
    exit 1
fi

# Create deploy/docker directory
mkdir -p deploy/docker

# Download OTLP collector config
if ! curl -fsSL -o deploy/docker/otel-collector-config.yml "${BASE_URL}/dashfrog/deploy/docker/otel-collector-config.yml"; then
    echo -e "${RED}âŒ Failed to download otel-collector-config.yml${NC}"
    exit 1
fi

# Download Prometheus config
if ! curl -fsSL -o deploy/docker/prometheus.yml "${BASE_URL}/dashfrog/deploy/docker/prometheus.yml"; then
    echo -e "${RED}âŒ Failed to download prometheus.yml${NC}"
    exit 1
fi

echo -e "${GREEN}âœ“ Configuration files downloaded${NC}"
echo ""

echo -e "${BLUE}ðŸ”§ Creating configuration...${NC}"

# Use default values from config.py for development/testing
# Users should change these for production
API_SECRET_KEY="change-this-secret-key-in-production"
POSTGRES_PASSWORD="postgres"
OTLP_AUTH_TOKEN="pwd"
API_PASSWORD="admin"

# Create .env file
cat > .env <<EOF
# DashFrog Configuration
# Generated by DashFrog installer on $(date)

# Secrets (using defaults - CHANGE IN PRODUCTION)
DASHFROG_API_SECRET_KEY=${API_SECRET_KEY}
DASHFROG_POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
DASHFROG_OTLP_AUTH_TOKEN=${OTLP_AUTH_TOKEN}

# Login credentials
DASHFROG_API_PASSWORD=${API_PASSWORD}
EOF

echo -e "${GREEN}âœ“ Configuration created with default values${NC}"
echo ""

echo -e "${BLUE}ðŸš€ Starting DashFrog...${NC}"
echo ""

# Start the stack
if ! docker compose up -d; then
    echo -e "${RED}âŒ Failed to start DashFrog${NC}"
    exit 1
fi

echo ""
echo -e "${YELLOW}â³ Waiting for DashFrog to be ready (this may take a minute)...${NC}"

# Wait for health check
MAX_ATTEMPTS=30
ATTEMPT=0
while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
    if docker compose ps | grep -q "dashfrog-api.*healthy"; then
        break
    fi
    sleep 2
    ATTEMPT=$((ATTEMPT + 1))
    echo -n "."
done

echo ""
echo ""

if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
    echo -e "${YELLOW}âš ï¸  DashFrog is starting but health check is taking longer than expected.${NC}"
    echo -e "${YELLOW}   Check logs with: docker compose logs -f${NC}"
    echo ""
else
    echo -e "${GREEN}âœ“ DashFrog is running!${NC}"
    echo ""
fi


# Start demo if requested
if [ "$WITH_DEMO" = true ]; then
    echo -e "${BLUE}ðŸš€ Starting demo...${NC}"
    echo ""

    # Download demo script
    curl -fsSL "${BASE_URL}/dashfrog/demo-app/demo.py" -o demo.py

    # Run demo using docker (uses defaults from config.py)
    echo -e "${BLUE}Installing dependencies and starting demo...${NC}"
    docker run \
        --network host \
        -v "$(pwd)/demo.py:/app/demo.py" \
        python:3.12-slim \
        bash -c "pip install -q dashfrog requests && python -u /app/demo.py"

    # Wait a moment for demo to start
    sleep 2

    echo ""
    echo -e "${GREEN}âœ“ Demo is running!${NC}"
    echo ""
    echo -e "${BLUE}The demo will generate data and create notebooks.${NC}"
    echo -e "${BLUE}View notebook links:${NC} docker logs dashfrog-demo"
    echo ""
    echo -e "${BLUE}Follow live output:${NC} docker logs -f dashfrog-demo"
    echo -e "${BLUE}Stop demo:${NC} docker stop dashfrog-demo && docker rm dashfrog-demo"
    echo ""
fi

# Print success message
echo ""
echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${GREEN}â•‘     ðŸŽ‰ Installation Complete! ðŸŽ‰      â•‘${NC}"
echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""
echo -e "${BLUE}ðŸ“ Access DashFrog at:${NC} http://localhost:8000"
echo -e "${BLUE}ðŸ‘¤ Username:${NC} admin"
echo -e "${BLUE}ðŸ”‘ Password:${NC} ${API_PASSWORD}"
echo ""
echo -e "${RED}âš ï¸  Using default passwords for development!${NC}"
echo "   For production, edit .env and change:"
echo "   - DASHFROG_API_SECRET_KEY"
echo "   - DASHFROG_POSTGRES_PASSWORD"
echo "   - DASHFROG_OTLP_AUTH_TOKEN"
echo "   - DASHFROG_API_PASSWORD"
echo "   Then run: docker compose down -v && docker compose up -d"
