# Development Docker Compose for DashFrog
# Builds from source instead of using pre-built images
#
# Usage:
#   docker compose -f docker-compose.dev.yml up -d

services:
  # DashFrog API Server
  dashfrog-api:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    networks:
      - dashfrog
    ports:
      - "8000:8000"
    environment:
      DASHFROG_POSTGRES_PASSWORD: ${DASHFROG_POSTGRES_PASSWORD}
      DASHFROG_API_PASSWORD: ${DASHFROG_API_PASSWORD:-admin}
      DASHFROG_API_SECRET_KEY: ${DASHFROG_API_SECRET_KEY}
    depends_on:
      postgres:
        condition: service_healthy
      otel-collector:
        condition: service_started
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    networks:
      - dashfrog
    environment:
      POSTGRES_PASSWORD: ${DASHFROG_POSTGRES_PASSWORD}
      POSTGRES_DB: dashfrog
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d dashfrog"]
      interval: 10s
      timeout: 5s
      retries: 5

  # OpenTelemetry Collector
  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.114.0
    restart: unless-stopped
    command: ["--config=/etc/otel-collector-config.yml"]
    networks:
      - dashfrog
    volumes:
      - ./deploy/docker/otel-collector-config.yml:/etc/otel-collector-config.yml:ro
    ports:
      - "4317:4317"
      - "4318:4318"
    environment:
      DASHFROG_OTLP_AUTH_TOKEN: ${DASHFROG_OTLP_AUTH_TOKEN}
    depends_on:
      - prometheus

  # Prometheus for Metrics Storage
  prometheus:
    image: prom/prometheus:v2.54.1
    restart: unless-stopped
    networks:
      - dashfrog
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=15d"
      - "--web.console.libraries=/etc/prometheus/console_libraries"
      - "--web.console.templates=/etc/prometheus/consoles"
      - "--web.enable-lifecycle"
      - "--enable-feature=native-histograms"
      - "--enable-feature=created-timestamp-zero-ingestion"
      - "--web.enable-remote-write-receiver"
    volumes:
      - ./deploy/docker/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus

networks:
  dashfrog:
    driver: bridge

volumes:
  postgres-data:
  prometheus-data:
